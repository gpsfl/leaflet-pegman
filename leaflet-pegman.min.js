/**
 * leaflet-pegman
 *
 * @author    Raruto
 * @license   GPL-3.0+
 * @link https://github.com/Raruto/leaflet-pegman
 * @desc Leaflet plugin that allows an easy integration with the Google StreetView Service API
 */
L.Control.Pegman=L.Control.extend({includes:L.Evented?L.Evented.prototype:L.Mixin.Events,options:{position:"bottomright",theme:"leaflet-pegman-v3-default",debug:!1,apiKey:"",libraries:"",mutant:{attribution:'Map data: &copy; <a href="https://www.google.com/intl/en/help/terms_maps.html">Google</a>',pane:"overlayPane",type:null},pano:{enableCloseButton:!0,fullscreenControl:!1,imageDateControl:!0},marker:{draggable:!0,icon:L.icon({className:"pegman-marker",iconSize:[52,52],iconAnchor:[24,33],iconUrl:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAFElEQVR4XgXAAQ0AAABAMP1L30IDCPwC/o5WcS4AAAAASUVORK5CYII="})},downloadTiles:!0},__interactURL:"https://unpkg.com/interactjs@1.2.9/dist/interact.min.js",__gmapsURL:"https://maps.googleapis.com/maps/api/js?v=3",__mutantURL:"https://unpkg.com/leaflet.gridlayer.googlemutant@0.10.0/Leaflet.GoogleMutant.js",initialize:function(e){void 0!==e.logging&&(e.debug=e.logging),L.Util.setOptions(this,e),this._mousePos={direction:{},old:{}},this._pegmanMarkerCoords=null,this._streetViewCoords=null,this._streetViewLayerEnabled=!1,this._dropzoneMapOpts={accept:".draggable",overlap:.75,ondropactivate:L.bind(this.onDropZoneActivated,this),ondragenter:L.bind(this.onDropZoneDragEntered,this),ondragleave:L.bind(this.onDropZoneDragLeaved,this),ondrop:L.bind(this.onDropZoneDropped,this),ondropdeactivate:L.bind(this.onDropZoneDeactivated,this)},this._draggableMarkerOpts={inertia:!1,onmove:L.bind(this.onDraggableMove,this),onend:L.bind(this.onDraggableEnd,this)},this._lazyLoaderAdded=!1},onAdd:function(e){return this._map=e,this._container=L.DomUtil.create("div","leaflet-pegman pegman-control leaflet-bar"),this._pegman=L.DomUtil.create("div","pegman draggable drag-drop",this._container),this._pegmanButton=L.DomUtil.create("div","pegman-button",this._container),this._pegmanMarker=L.marker([0,0],this.options.marker),this._panoDiv=this.options.panoDiv?document.querySelector(this.options.panoDiv):L.DomUtil.create("div","",this._map._container),L.DomUtil.addClass(this._panoDiv,"pano-canvas"),L.DomUtil.addClass(this._map._container,this.options.theme),L.DomEvent.disableClickPropagation(this._panoDiv),L.DomEvent.on(this._container,"click mousedown dblclick",this._disableClickPropagation,this),this._container.addEventListener("touchstart",this._loadScripts.bind(this,!L.Browser.touch),{once:!0}),this._container.addEventListener("mousedown",this._loadScripts.bind(this,!0),{once:!0}),this._container.addEventListener("mouseover",this._loadScripts.bind(this,!1),{once:!0}),this._loadInteractHandlers(),this._loadGoogleHandlers(),L.DomEvent.on(document,"mousemove",this.mouseMoveTracking,this),L.DomEvent.on(document,"keyup",this.keyUpTracking,this),this._pegmanMarker.on("dragend",this.onPegmanMarkerDragged,this),this._map.on("click",this.onMapClick,this),this._map.on("layeradd",this.onMapLayerAdd,this),this._container},onRemove:function(e){interact(this._pegman).unset(),interact(this._map._container).unset(),interact(this._container).unset(),this._googleStreetViewLayer&&this._googleStreetViewLayer.remove(),this._pegmanMarker&&this._pegmanMarker.remove(),L.DomUtil.remove(this._panoDiv),L.DomEvent.off(document,"mousemove",this.mouseMoveTracking,this),L.DomEvent.off(document,"keyup",this.keyUpTracking,this),e.off("mousemove",this._setMouseCursor,this)},_log:function(e){this.options.debug&&console.log(e)},_addClasses:function(e,t){for(var a in t=t.split(" "))L.DomUtil.addClass(e,t[a])},_removeClasses:function(e,t){for(var a in t=t.split(" "))L.DomUtil.removeClass(e,t[a])},_removeAttributes:function(e,t){for(var a in t)e.removeAttribute(t[a])},_insertAfter:function(e,t){e.parentNode.insertBefore(t,e.nextSibling)},_translateElement:function(e,t,a){!1===t&&!1===a&&this._removeAttributes(this._pegman,["style","data-x","data-y"]);var i=(parseFloat(e.getAttribute("data-x"))||0)+t,o=(parseFloat(e.getAttribute("data-y"))||0)+a;e.style.webkitTransform=e.style.transform="translate("+i+"px, "+o+"px)",e.setAttribute("data-x",i),e.setAttribute("data-y",o)},_updateClasses:function(e){switch(e){case"pegman-dragging":this._removeClasses(this._pegman,"dropped"),this._addClasses(this._container,"dragging");break;case"pegman-dragged":this._removeClasses(this._pegman,"can-drop dragged left right active dropped"),this._removeAttributes(this._pegman,["style","data-x","data-y"]);break;case"dropzone-actived":this._addClasses(this._map._container,"drop-active");break;case"dropzone-drag-entered":this._addClasses(this._pegman,"active can-drop"),this._addClasses(this._map._container,"drop-target");break;case"dropzone-drag-leaved":this._removeClasses(this._map._container,"drop-target"),this._removeClasses(this._pegman,"can-drop");break;case"dropzone-drop":this._removeClasses(this._container,"dragging"),this._removeClasses(this._pegman,"active left right"),this._addClasses(this._pegman,"dropped"),this._removeClasses(this._pegman,"can-drop dragged left right active dropped");break;case"dropzone-deactivated":this._removeClasses(this._pegman,"active left right"),this._removeClasses(this._map._container,"drop-active drop-target");break;case"mousemove-top":this._addClasses(this._pegman,"top"),this._removeClasses(this._pegman,"bottom right left");break;case"mousemove-bottom":this._addClasses(this._pegman,"bottom"),this._removeClasses(this._pegman,"top right left");break;case"mousemove-left":this._addClasses(this._pegman,"left"),this._removeClasses(this._pegman,"right top bottom");break;case"mousemove-right":this._addClasses(this._pegman,"right"),this._removeClasses(this._pegman,"left top bottom");break;case"pegman-added":this._addClasses(this._container,"active");break;case"pegman-removed":this._removeClasses(this._container,"active");break;case"streetview-shown":this._addClasses(this._container,"streetview-layer-active");break;case"streetview-hidden":this._removeClasses(this._container,"streetview-layer-active");break;default:throw"Unhandled event:"+e}this.fire("svpc_"+e)},onDraggableMove:function(e){this.mouseMoveTracking(e),this.pegmanRemove(),this._updateClasses("pegman-dragging"),this._translateElement(this._pegman,e.dx,e.dy)},onDraggableEnd:function(e){this._pegmanMarkerCoords=this._map.mouseEventToLatLng(e),this.pegmanAdd(),this.findStreetViewData(this._pegmanMarkerCoords.lat,this._pegmanMarkerCoords.lng),this._updateClasses("pegman-dragged")},onDropZoneActivated:function(e){this._updateClasses("dropzone-actived")},onDropZoneDragEntered:function(e){this.showStreetViewLayer(),this._updateClasses("dropzone-drag-entered")},onDropZoneDragLeaved:function(e){this._updateClasses("dropzone-drag-leaved")},onDropZoneDropped:function(e){this._updateClasses("dropzone-drop"),this._translateElement(this._pegman,!1,!1)},onDropZoneDeactivated:function(e){this._updateClasses("dropzone-deactivated")},onPegmanMarkerDragged:function(e){this._pegmanMarkerCoords=this._pegmanMarker.getLatLng(),this.findStreetViewData(this._pegmanMarkerCoords.lat,this._pegmanMarkerCoords.lng)},onMapClick:function(e){this._streetViewLayerEnabled&&this.findStreetViewData(e.latlng.lat,e.latlng.lng)},onMapLayerAdd:function(e){this._googleStreetViewLayer&&this._googleStreetViewLayer.bringToFront()},onStreetViewPanoramaClose:function(){this.clear()},onPanoramaPositionChanged:function(){var e=this._getOrCreatePanorama().getPosition();e=L.latLng(e.lat(),e.lng()),this._map&&!this._map.getBounds().pad(-.05).contains(e)&&this._map.panTo(e),this._pegmanMarker.setLatLng(e)},onPanoramaPovChanged:function(){var e=this._getOrCreatePanorama().getPov();this._pegmanMarker.getElement().style.backgroundPosition="0 "+-Math.abs(Math.round(e.heading/22.5)%16*Math.round(835/16))+"px"},clear:function(){this.pegmanRemove(),this.hideStreetViewLayer(),this.closeStreetViewPanorama()},toggleStreetViewLayer:function(e){this._streetViewLayerEnabled?this.clear():this.showStreetViewLayer(),this._log("streetview-layer-toggled")},pegmanAdd:function(){this._pegmanMarker.addTo(this._map),this._pegmanMarker.setLatLng(this._pegmanMarkerCoords),this.findStreetViewData(this._pegmanMarkerCoords.lat,this._pegmanMarkerCoords.lng),this._updateClasses("pegman-added")},pegmanRemove:function(){this._pegmanMarker.removeFrom(this._map),this._updateClasses("pegman-removed")},closeStreetViewPanorama:function(){this._panoDiv.style.display="none"},openStreetViewPanorama:function(){this._panoDiv.style.display="block"},hideStreetViewLayer:function(){this._googleStreetViewLayer&&(this._googleStreetViewLayer.removeFrom(this._map),this._streetViewLayerEnabled=!1,this._updateClasses("streetview-hidden"))},showStreetViewLayer:function(){this._googleStreetViewLayer&&(this._googleStreetViewLayer.addTo(this._map),this._streetViewLayerEnabled=!0,this._updateClasses("streetview-shown"))},findStreetViewData:function(e,t){if("undefined"==typeof google)return this._loadScripts(!0),this.once("svpc_streetview-shown",L.bind(this.findStreetViewData,this,e,t));if(!this._pegmanMarker._map&&this._map)return this._pegmanMarkerCoords=L.latLng(e,t),this.pegmanAdd();this._streetViewCoords=new google.maps.LatLng(e,t);var a=this._map.getZoom(),i=100;i=a<6?5e3:a<10?500:a<15?250:a>=17?50:100,this._streetViewService.getPanoramaByLocation(this._streetViewCoords,i,L.bind(this.processStreetViewServiceData,this))},processStreetViewServiceData:function(e,t){if(t==google.maps.StreetViewStatus.OK){this.openStreetViewPanorama();var a=this._getOrCreatePanorama();a.setPano(e.location.pano),a.setPov({heading:google.maps.geometry.spherical.computeHeading(e.location.latLng,this._streetViewCoords),pitch:0,zoom:0}),a.setVisible(!0)}else console.warn("Street View data not found for this location.")},mouseMoveTracking:function(e){var t=this._mousePos;e.pageY<t.old.y?(t.direction.y="top",this._updateClasses("mousemove-top")):e.pageY>t.old.y&&(t.direction.y="bottom",this._updateClasses("mousemove-bottom")),e.pageX<t.old.x?(t.direction.x="left",this._updateClasses("mousemove-left")):e.pageX>t.old.x&&(t.direction.x="right",this._updateClasses("mousemove-right")),t.old.x=e.pageX,t.old.y=e.pageY},keyUpTracking:function(e){27==e.keyCode&&(this._log("escape pressed"),this.clear())},_disableClickPropagation:function(e){L.DomEvent.stopPropagation(e),L.DomEvent.preventDefault(e)},_loadGoogleHandlers:function(e){"object"==typeof google&&"object"==typeof google.maps&&"function"==typeof L.GridLayer.GoogleMutant&&(this._initGoogleMaps(e),this._initMouseTracker())},_initGoogleMaps:function(e){this._googleStreetViewLayer=L.gridLayer.googleMutant(this.options.mutant),this._googleStreetViewLayer.addGoogleLayer("StreetViewCoverageLayer"),this._streetViewService=new google.maps.StreetViewService,e&&this.showStreetViewLayer()},_getOrCreatePanorama:function(){return null!=this._panorama||(this._panorama=new google.maps.StreetViewPanorama(this._panoDiv,this.options.pano),this._panorama.addListener("closeclick",L.bind(this.onStreetViewPanoramaClose,this)),this._panorama.addListener("position_changed",L.bind(this.onPanoramaPositionChanged,this)),this._panorama.addListener("pov_changed",L.bind(this.onPanoramaPovChanged,this))),this._panorama},_initMouseTracker:function(){if(this._googleStreetViewLayer){var e=this._googleStreetViewLayer.getTileSize();this.tileWidth=e.x,this.tileHeight=e.y,this.defaultDraggableCursor=this._map._container.style.cursor,this._map.on("mousemove",this._setMouseCursor,this)}},_setMouseCursor:function(e){var t=this._getTileCoords(e.latlng.lat,e.latlng.lng,this._map.getZoom()),a=this._getTileImage(t),i=this._getTilePixelPoint(a,e.originalEvent),o=this._hasTileData(a,i);this._map._container.style.cursor=o?"pointer":this.defaultDraggableCursor},_getTileCoords:function(e,t,a){return{x:parseInt(Math.floor((t+180)/360*(1<<a))),y:parseInt(Math.floor((1-Math.log(Math.tan(this._toRad(e))+1/Math.cos(this._toRad(e)))/Math.PI)/2*(1<<a))),z:a}},_getTileImage:function(e){if(this._googleStreetViewLayer&&this._googleStreetViewLayer._tiles){var t=this._googleStreetViewLayer._tileCoordsToKey(e),a=this._googleStreetViewLayer._tiles[t];if(a){var i=a.el.querySelector("img");if(i)return this._downloadTile(i.src,this._tileLoaded),i}}},_getTilePixelPoint:function(e,t){if(e){var a=e.getBoundingClientRect(),i=(a.top+window.scrollY).toFixed(0),o=(a.left+window.scrollX).toFixed(0);return{x:t.pageX-o,y:t.pageY-i}}},_hasTileData:function(e,t){if(this.tileContext&&t)return 0!=this.tileContext.getImageData(t.x,t.y,1,1).data[3]},_toRad:function(e){return e*Math.PI/180},_downloadTile:function(e,t){if(e&&this.options.downloadTiles){var a=new Image;a.crossOrigin="Anonymous",a.addEventListener("load",t.bind(this,a),!1),a.src=e}},_tileLoaded:function(e){this.tileCanvas=document.createElement("canvas"),this.tileContext=this.tileCanvas.getContext("2d"),this.tileCanvas.width=this.tileWidth,this.tileCanvas.height=this.tileHeight,this.tileContext.drawImage(e,0,0)},_loadInteractHandlers:function(){"function"==typeof interact&&(this._draggable=interact(this._pegman).draggable(this._draggableMarkerOpts),this._dropzone=interact(this._map._container).dropzone(this._dropzoneMapOpts),this._draggable.styleCursor(!1),interact(this._container).on("tap",L.bind(this.toggleStreetViewLayer,this)),L.DomEvent.on(this._container,"touchstart",(function(e){this._map.dragging.disable()}),this),L.DomEvent.on(this._container,"touchend",(function(e){this._map.dragging.enable()}),this))},_loadScripts:function(e){this._lazyLoaderAdded||(this._lazyLoaderAdded=!0,this._loadJS(this.__interactURL,this._loadInteractHandlers.bind(this),"function"!=typeof interact),this._loadJS(this.__gmapsURL+"&key="+this.options.apiKey+"&libraries="+this.options.libraries+"&callback=?",this._loadGoogleHandlers.bind(this,e),"object"!=typeof google||"object"!=typeof google.maps),this._loadJS(this.__mutantURL,this._loadGoogleHandlers.bind(this,e),"function"!=typeof L.GridLayer.GoogleMutant))},_loadJS:function(e,t,a){if(a)if(-1!==e.indexOf("callback=?"))this._jsonp(e,t);else{var i=document.createElement("script");i.src=e;var o=function(){i.onload=i.onreadystatechange=null,this._log(e+" loaded"),t()}.bind(this);i.onload=i.onreadystatechange=o;var s=document.head||document.getElementsByTagName("head")[0]||document.documentElement;s.insertBefore(i,s.firstChild)}else t()},_jsonp:function(e,t,a){var i=-1===e.indexOf("?")?"?":"&";for(var o in a=a||{})a.hasOwnProperty(o)&&(i+=encodeURIComponent(o)+"="+encodeURIComponent(a[o])+"&");var s="json_call_"+(new Date).getUTCMilliseconds();window[s]=function(e){t(e),window[s]=void 0};var n=document.createElement("script");-1!==e.indexOf("callback=?")?n.src=e.replace("callback=?","callback="+s)+i.slice(0,-1):n.src=e+i+"callback="+s;n.async=!0,n.onload=n.onreadystatechange=function(){this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(n.onload=n.onreadystatechange=null,n&&n.parentNode&&n.parentNode.removeChild(n))};var r=document.head||document.getElementsByTagName("head")[0]||document.documentElement;r.insertBefore(n,r.firstChild)}}),L.control.pegman=function(e){return new L.Control.Pegman(e)};